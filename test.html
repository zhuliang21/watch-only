<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin zpub åˆ°åœ°å€è½¬æ¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            input[type="text"] {
                width: 100% !important;
                box-sizing: border-box;
            }
            
            button {
                width: 100% !important;
                margin: 5px 0 !important;
                padding: 12px !important;
                font-size: 16px !important;
            }
            
            #chartContainer {
                margin: 10px 0 !important;
                padding: 15px !important;
            }
            
            #balanceDisplay {
                font-size: 20px !important;
                top: 15px !important;
                right: 15px !important;
            }
            
            #autoDetectStatus {
                padding: 10px !important;
                margin-top: 15px !important;
            }
            
            #autoDetectStatus > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px !important;
            }
            
            #detectionLog {
                font-size: 11px !important;
                max-height: 80px !important;
            }
            
            #newTransactionAlert {
                padding: 8px !important;
                font-size: 14px !important;
            }
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group button {
            flex: 1;
            min-width: 120px;
            padding: 10px 20px;
            border: none;
            background: #28a745;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .button-group button:hover {
            background: #218838;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <!-- Gate Overlay -->
    <!-- gate overlay removed -->

    <h1>Bitcoin zpub åˆ°åœ°å€è½¬æ¢</h1>
    
    <div>
        <label for="zpubInput">è¾“å…¥ zpub:</label>
        <br>
        <input type="text" id="zpubInput" placeholder="è¾“å…¥ä½ çš„ zpub..." style="width: 500px; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
        <br>
        <button onclick="writeZpub()" style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 16px;">å†™å…¥ zpub</button>
    </div>
    
    <div id="result" style="margin-top: 20px;">
        <h3>ç»“æœ:</h3>
        <p id="status" style="color: green;"></p>
        <p id="error" style="color: red;"></p>
    </div>

    <script src="dist/generate.bundle.js"></script>
    <script src="dist/check.bundle.js"></script>
    <script src="dist/history.bundle.js"></script>
    <script src="dist/gate.bundle.js"></script>
    <script src="dist/update.bundle.js"></script>
    <script>
      const verifyZpub = window.verifyZpub;

      async function writeZpub() {
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        statusEl.textContent = '';
        errorEl.textContent = '';

        const z = document.getElementById('zpubInput').value.trim();
        if (!z) {
          errorEl.textContent = 'è¯·è¾“å…¥ zpub';
          return;
        }

        // åŸºæœ¬æ ¼å¼æ ¡éªŒ
        if (!z.startsWith('zpub')) {
          errorEl.textContent = 'æ‰©å±•å…¬é’¥åº”ä»¥ zpub å¼€å¤´';
          return;
        }

        const result = await verifyZpub(z);
        if (!result || result.ok !== true) {
          errorEl.textContent = 'æ— æƒé™æˆ– zpub ä¸åŒ¹é…';
          return;
        }

        localStorage.currentZpub = z;
        statusEl.textContent = 'zpub å·²å†™å…¥å¹¶é€šè¿‡éªŒè¯ï¼Œå¯ç»§ç»­ç”Ÿæˆåœ°å€';
      }

      function clearData() {
        localStorage.clear();
        const statusEl = document.getElementById('status');
        const errorEl = document.getElementById('error');
        statusEl.textContent = 'å·²æ¸…ç©º localStorage';
        errorEl.textContent = '';
      }

      // æ±‡æ€»ä¿¡æ¯åˆ·æ–°å‡½æ•°
      window.refreshSummary = function() {
        const total = JSON.parse(localStorage.getItem('totalBalance') || 'null');
        const mempool = JSON.parse(localStorage.getItem('mempoolIncomingTotal') || 'null');
        const totalEl = document.getElementById('summaryTotalBalance');
        const mpEl = document.getElementById('summaryMempool');
        if(totalEl) totalEl.textContent = total ? `${total.btc} BTC` : '--';
        if(mpEl) mpEl.textContent = mempool ? `${(mempool.totalSat/1e8).toFixed(8)} BTC` : '--';
      };
    </script>

    <div class="button-group">
        <button onclick="generateAddresses()">ç”Ÿæˆåœ°å€åˆ—è¡¨</button>
        <button onclick="checkAddresses()">æ£€æŸ¥åœ°å€çŠ¶æ€</button>
        <button onclick="getReceiveAddress()">æ¥æ”¶åœ°å€</button>
        <button onclick="computeTotalBalance()">è®¡ç®—æ€»ä½™é¢</button>
        <button onclick="checkMempoolIncoming()">æ£€æµ‹æœªç¡®è®¤æ”¶å…¥</button>
        <button onclick="fetchTxHistory()">æ‹‰å–äº¤æ˜“</button>
        <button onclick="buildBalanceTable()">ç”Ÿæˆä½™é¢è¡¨</button>
        <button onclick="drawBalanceChart()">ç”Ÿæˆä½™é¢æ›²çº¿</button>
        <button id="autoDetectBtn" onclick="toggleAutoDetect()" style="background:#ffc107;">å¼€å¯è‡ªåŠ¨æ£€æµ‹</button>
        <button onclick="clearData()" style="background:#dc3545;">æ¸…é™¤æ•°æ®</button>
    </div>

    <!-- è‡ªåŠ¨æ£€æµ‹çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="autoDetectStatus" style="display:none; margin-top:20px; padding:15px; background:#e9ecef; border-radius:8px; border-left:4px solid #007bff;">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <div>
                <strong>è‡ªåŠ¨æ£€æµ‹çŠ¶æ€ï¼š</strong>
                <span id="detectStatusText">ç­‰å¾…å¼€å¯</span>
            </div>
            <div style="font-size:14px; color:#666;">
                ä¸‹æ¬¡æ£€æµ‹: <span id="nextDetectTime">--</span>
            </div>
        </div>
        <div id="newTransactionAlert" style="display:none; margin-top:10px; padding:10px; background:#d4edda; border:1px solid #c3e6cb; border-radius:4px; color:#155724;">
            ğŸ‰ <strong>å‘ç°æ–°äº¤æ˜“ï¼</strong> <span id="newTxDetails"></span>
        </div>
        <div id="detectionLog" style="margin-top:10px; font-size:12px; color:#666; max-height:100px; overflow-y:auto;"></div>
    </div>

    <div style="margin-top:20px; max-width:100%; position: relative;">
        <div id="chartContainer" style="position: relative; background: #000; border-radius: 12px; padding: 20px; margin: 10px 0;">
            <div id="balanceDisplay" style="position: absolute; top: 20px; left: 20px; color: #00d4aa; font-size: 24px; font-weight: bold; z-index: 10; font-family: 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', monospace;"></div>
            <canvas id="balanceChart" style="width: 100%; height: 200px;"></canvas>
        </div>
    </div>

    <!-- æ±‡æ€»ä¿¡æ¯ -->
    <div id="summary" style="margin-top: 20px; padding: 10px; background:#f1f3f5; border-radius:6px;">
        <strong>æ€»ä½™é¢:</strong> <span id="summaryTotalBalance">--</span>
        &nbsp;&nbsp;|&nbsp;&nbsp;
        <strong>æœªç¡®è®¤æ€»é¢:</strong> <span id="summaryMempool">--</span>
    </div>
</body>
</html> 
