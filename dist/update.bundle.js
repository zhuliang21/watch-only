(()=>{let e=null,t=null,n=!1,a=0;function o(){n=!0,c(),e=setInterval(c,3e4),a=Date.now()+3e4,t=setInterval(()=>{const e=Math.max(0,a-Date.now()),t=Math.ceil(e/1e3),n=document.getElementById("nextDetectTime");n&&(n.textContent=e<=0?"æ£€æµ‹ä¸­...":`${t}ç§’`)},1e3),s("ðŸŸ¢ è‡ªåŠ¨æ£€æµ‹å·²å¯åŠ¨ï¼Œé—´éš”30ç§’")}async function c(){try{s(`ðŸ” å¼€å§‹æ£€æµ‹... (${(new Date).toLocaleTimeString()})`);const e=JSON.parse(localStorage.getItem("addressStatuses")||"[]"),t=JSON.parse(localStorage.getItem("totalBalance")||"null"),n=t?t.satoshi:0;await window.checkAddresses();const o=JSON.parse(localStorage.getItem("addressStatuses")||"[]");window.computeTotalBalance&&window.computeTotalBalance(),s("ðŸ’° æ€»ä½™é¢å·²æ›´æ–°"),window.checkMempoolIncoming&&(await window.checkMempoolIncoming(),s("ðŸ’± æœªç¡®è®¤ä½™é¢å·²æ›´æ–°"));const c=JSON.parse(localStorage.getItem("totalBalance")||"null");(c?c.satoshi:0)!==n?(s("ðŸ“ˆ æ£€æµ‹åˆ°ä½™é¢å˜åŒ–ï¼Œåˆ·æ–°äº¤æ˜“åŽ†å²ä¸Žä½™é¢è¡¨"),window.fetchTxHistory&&await window.fetchTxHistory(),window.buildBalanceTable&&window.buildBalanceTable(),window.renderRecentTxs&&window.renderRecentTxs()):s("âš–ï¸ ä½™é¢æ— å˜åŒ–");const l=function(e,t){const n=[],a=new Map;return e.forEach(e=>{a.set(e.address,e)}),t.forEach(e=>{const t=a.get(e.address);if(t){const a=e.balance!==t.balance,o=e.used!==t.used,c=(e.n_tx||0)!==(t.n_tx||0);if(a||o||c){const o=a?e.balance>t.balance?"æŽ¥æ”¶":"å‘é€":c?"æœªç¡®è®¤äº¤æ˜“":"çŠ¶æ€å˜æ›´";n.push({address:e.address,path:e.path,previousBalance:t.balance,currentBalance:e.balance,balanceChange:e.balance-t.balance,previousUsed:t.used,currentUsed:e.used,previousTxCount:t.n_tx||0,currentTxCount:e.n_tx||0,changeType:o})}}else(e.used||e.balance>0)&&n.push({address:e.address,path:e.path,previousBalance:0,currentBalance:e.balance,balanceChange:e.balance,previousUsed:!1,currentUsed:e.used,previousTxCount:0,currentTxCount:e.n_tx||0,changeType:"æ–°åœ°å€äº¤æ˜“"})}),n}(e,o);l.length>0?(function(e){const t=document.getElementById("newTransactionAlert"),n=document.getElementById("newTxDetails");if(!t||!n)return;let a="";e.forEach(e=>{const t=e.balanceChange>0?`+${(e.balanceChange/1e8).toFixed(8)} BTC`:e.balanceChange<0?`${(e.balanceChange/1e8).toFixed(8)} BTC`:"0 BTC",n=e.currentTxCount>e.previousTxCount?` (äº¤æ˜“æ•°: ${e.previousTxCount}â†’${e.currentTxCount})`:"";a+=`${e.changeType} - åœ°å€ ${e.address.substring(0,8)}...${e.address.slice(-8)} ä½™é¢å˜åŒ–: ${t}${n}; `}),n.textContent=a,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},1e4)}(l),s(`âœ… å‘çŽ° ${l.length} ä¸ªæ–°äº¤æ˜“`)):(function(){const e=document.getElementById("newTransactionAlert");e&&(e.style.display="none")}(),s("âœ… æ£€æµ‹å®Œæˆï¼Œæ— æ–°äº¤æ˜“")),a=Date.now()+3e4}catch(e){s(`âŒ æ£€æµ‹å¤±è´¥: ${e.message}`),console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",e)}}function s(e){const t=document.getElementById("detectionLog");if(!t)return;const n=(new Date).toLocaleTimeString(),a=document.createElement("div");for(a.textContent=`[${n}] ${e}`,t.appendChild(a);t.children.length>10;)t.removeChild(t.firstChild);t.scrollTop=t.scrollHeight}window.toggleAutoDetect=function(){const a=document.getElementById("autoDetectBtn"),c=document.getElementById("autoDetectStatus"),l=document.getElementById("detectStatusText");n?(function(){n=!1,e&&(clearInterval(e),e=null),t&&(clearInterval(t),t=null);const a=document.getElementById("nextDetectTime");a&&(a.textContent="--"),s("ðŸ”´ è‡ªåŠ¨æ£€æµ‹å·²åœæ­¢")}(),a&&(a.textContent="å¼€å¯è‡ªåŠ¨æ£€æµ‹",a.style.background="#ffc107"),c&&(c.style.display="none"),l&&(l.textContent="å·²åœæ­¢")):(o(),a&&(a.textContent="åœæ­¢è‡ªåŠ¨æ£€æµ‹",a.style.background="#dc3545"),c&&(c.style.display="block"),l&&(l.textContent="è¿è¡Œä¸­"))},window.startAutoDetectSilent=function(){n||o()},window.addEventListener("beforeunload",()=>{e&&clearInterval(e),t&&clearInterval(t)}),window.getAutoDetectStatus=function(){return{isAutoDetecting:n,nextDetectTimeStamp:a}},window.checkMempoolIncoming=async function(){try{const e=JSON.parse(localStorage.getItem("addressStatuses")||"[]"),t=JSON.parse(localStorage.getItem("paymentAddresses")||"[]");if(!e.length||!t.length)return;let n=null;for(const a of t){const t=e.find(e=>e.address===a.address);if(t&&!t.used){n=a.address;break}}if(n||(n=t[t.length-1]?.address),!n)return;const a=new AbortController,o=setTimeout(()=>a.abort(),5e3);try{const e=`https://blockstream.info/api/address/${n}/txs/mempool`,t=await fetch(e,{signal:a.signal});if(clearTimeout(o),!t.ok)return;const c=await t.json();let s=0;const l=[],r=Math.floor(Date.now()/1e3);c.forEach(e=>{let t=0;(e.vout||[]).forEach(e=>{e.scriptpubkey_address===n&&(t+=e.value)}),(e.vin||[]).forEach(e=>{const a=e.prevout;a&&a.scriptpubkey_address===n&&(t-=a.value)}),0!==t&&(s+=t,l.push({txid:e.txid,d:t,ts:r,mempool:!0}))}),localStorage.setItem("mempoolIncomingTotal",JSON.stringify({totalSat:s,time:Date.now()})),localStorage.setItem("mempoolTxDeltas",JSON.stringify(l)),"function"==typeof window.refreshSummary&&window.refreshSummary()}catch(e){clearTimeout(o)}}catch(e){}}})();