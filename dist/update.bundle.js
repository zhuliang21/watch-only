(()=>{let e=null,t=null,n=!1,o=0;function a(){n=!0,c(),e=setInterval(c,3e4),o=Date.now()+3e4,t=setInterval(()=>{const e=Math.max(0,o-Date.now()),t=Math.ceil(e/1e3),n=document.getElementById("nextDetectTime");n&&(n.textContent=e<=0?"检测中...":`${t}秒`)},1e3),r("🟢 自动检测已启动，间隔30秒")}async function c(){try{r(`🔍 开始检测... (${(new Date).toLocaleTimeString()})`);const e=JSON.parse(localStorage.getItem("addressStatuses")||"[]"),t=JSON.parse(localStorage.getItem("totalBalance")||"null"),n=t?t.satoshi:0;await window.checkAddresses();const a=JSON.parse(localStorage.getItem("addressStatuses")||"[]");window.computeTotalBalance&&window.computeTotalBalance(),r("💰 总余额已更新"),window.queryRMBPrice&&(await window.queryRMBPrice(),r("💴 人民币价格已更新")),window.checkMempoolIncoming&&(await window.checkMempoolIncoming(),r("💱 未确认余额已更新"));const c=JSON.parse(localStorage.getItem("totalBalance")||"null");(c?c.satoshi:0)!==n?(r("📈 检测到余额变化，刷新交易历史与余额表"),window.fetchTxHistory&&await window.fetchTxHistory(),window.buildBalanceTable&&window.buildBalanceTable()):r("⚖️ 余额无变化");const s=function(e,t){const n=[],o=new Map;return e.forEach(e=>{o.set(e.address,e)}),t.forEach(e=>{const t=o.get(e.address);if(t){const o=e.balance!==t.balance,a=e.used!==t.used,c=(e.n_tx||0)!==(t.n_tx||0);if(o||a||c){const a=o?e.balance>t.balance?"接收":"发送":c?"未确认交易":"状态变更";n.push({address:e.address,path:e.path,previousBalance:t.balance,currentBalance:e.balance,balanceChange:e.balance-t.balance,previousUsed:t.used,currentUsed:e.used,previousTxCount:t.n_tx||0,currentTxCount:e.n_tx||0,changeType:a})}}else(e.used||e.balance>0)&&n.push({address:e.address,path:e.path,previousBalance:0,currentBalance:e.balance,balanceChange:e.balance,previousUsed:!1,currentUsed:e.used,previousTxCount:0,currentTxCount:e.n_tx||0,changeType:"新地址交易"})}),n}(e,a);s.length>0?(function(e){const t=document.getElementById("newTransactionAlert"),n=document.getElementById("newTxDetails");if(!t||!n)return;let o="";e.forEach(e=>{const t=e.balanceChange>0?`+${(e.balanceChange/1e8).toFixed(8)} BTC`:e.balanceChange<0?`${(e.balanceChange/1e8).toFixed(8)} BTC`:"0 BTC",n=e.currentTxCount>e.previousTxCount?` (交易数: ${e.previousTxCount}→${e.currentTxCount})`:"";o+=`${e.changeType} - 地址 ${e.address.substring(0,8)}...${e.address.slice(-8)} 余额变化: ${t}${n}; `}),n.textContent=o,t.style.display="block",setTimeout(()=>{t&&(t.style.display="none")},1e4)}(s),r(`✅ 发现 ${s.length} 个新交易`)):(function(){const e=document.getElementById("newTransactionAlert");e&&(e.style.display="none")}(),r("✅ 检测完成，无新交易")),o=Date.now()+3e4}catch(e){r(`❌ 检测失败: ${e.message}`),console.error("自动检测失败:",e)}}function r(e){const t=document.getElementById("detectionLog");if(!t)return;const n=(new Date).toLocaleTimeString(),o=document.createElement("div");for(o.textContent=`[${n}] ${e}`,t.appendChild(o);t.children.length>10;)t.removeChild(t.firstChild);t.scrollTop=t.scrollHeight}window.toggleAutoDetect=function(){const o=document.getElementById("autoDetectBtn"),c=document.getElementById("autoDetectStatus"),s=document.getElementById("detectStatusText");n?(function(){n=!1,e&&(clearInterval(e),e=null),t&&(clearInterval(t),t=null);const o=document.getElementById("nextDetectTime");o&&(o.textContent="--"),r("🔴 自动检测已停止")}(),o&&(o.textContent="开启自动检测",o.style.background="#ffc107"),c&&(c.style.display="none"),s&&(s.textContent="已停止")):(a(),o&&(o.textContent="停止自动检测",o.style.background="#dc3545"),c&&(c.style.display="block"),s&&(s.textContent="运行中"))},window.startAutoDetectSilent=function(){n||a()},window.addEventListener("beforeunload",()=>{e&&clearInterval(e),t&&clearInterval(t)}),window.getAutoDetectStatus=function(){return{isAutoDetecting:n,nextDetectTimeStamp:o}},window.checkMempoolIncoming=async function(){const e=document.getElementById("status"),t=document.getElementById("error");e&&(e.textContent=""),t&&(t.textContent="");try{const a=JSON.parse(localStorage.getItem("addressStatuses")||"[]"),c=JSON.parse(localStorage.getItem("paymentAddresses")||"[]"),r=JSON.parse(localStorage.getItem("changeAddresses")||"[]");if(!a.length||!c.length&&!r.length)throw new Error("请先生成地址并检查地址状态");const s=e=>{const t=e.split("/");return parseInt(t[t.length-1],10)},l=e=>{const t=a.filter(t=>t.used&&t.path.startsWith(e)).map(e=>s(e.path));return t.length?Math.max(...t):-1},i=l("m/0/"),d=l("m/1/");if(-1===i&&-1===d)throw new Error("尚未检测到任何已使用地址");function n(e,t){const n=[];t>=0&&e[t]&&n.push(e[t]);for(let o=1;o<=2;o++){const a=t+o;a>=0&&e[a]&&n.push(e[a])}return n}const u=[...n(c,i),...n(r,d)],m=a.filter(e=>(e.balance||0)>0).map(e=>e.address),g=Array.from(new Set([...u.map(e=>e.address),...m]));if(!g.length)throw new Error("无法确定查询地址");const w=(await Promise.all(g.map(async function(e){const t=`https://blockstream.info/api/address/${e}/txs/mempool`,n=await fetch(t);if(!n.ok)throw new Error("mempool API 错误: "+n.status);const o=await n.json();let a=0;return o.forEach(t=>{(t.vout||[]).forEach(t=>{t.scriptpubkey_address===e&&(a+=t.value)}),(t.vin||[]).forEach(t=>{const n=t.prevout;n&&n.scriptpubkey_address===e&&(a-=n.value)})}),a}))).reduce((e,t)=>e+t,0),h=e=>(e/1e8).toFixed(8);localStorage.setItem("mempoolIncomingTotal",JSON.stringify({totalSat:w,time:Date.now()})),o=`未确认收入: ${h(w)} BTC`,e?e.textContent=o:console.log("STATUS:",o),"function"==typeof window.refreshSummary&&window.refreshSummary()}catch(p){(e=>{t?t.textContent=e:console.error("ERROR:",e)})("检测未确认收入失败: "+p.message)}var o},window.queryRMBPrice=async function(){const e=document.getElementById("status"),t=document.getElementById("error"),n=t=>{e?e.textContent=t:console.log("STATUS:",t)};e&&(e.textContent=""),t&&(t.textContent="");try{const e=JSON.parse(localStorage.getItem("totalBalance")||"null");if(!e||!e.btc)throw new Error("请先计算总余额");const t=e.btc;n("正在查询比特币价格...");const o=await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=cny");if(!o.ok)throw new Error(`API 请求失败: ${o.status}`);const a=await o.json(),c=a.bitcoin?.cny;if(!c)throw new Error("无法获取比特币价格数据");const r=t*c,s={btcPriceCNY:c,btcAmount:t,totalRMB:r,timestamp:Date.now(),updateTime:(new Date).toLocaleString("zh-CN")};localStorage.setItem("rmbPrice",JSON.stringify(s)),"function"==typeof window.refreshSummary&&window.refreshSummary(),n(`₿ 1 = ¥${c.toLocaleString("zh-CN")} | 总价值: ¥${r.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2})}`)}catch(e){o="查询人民币价格失败: "+e.message,t?t.textContent=o:console.error("ERROR:",o)}var o}})();